<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live Trip - Zesty Tour</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    #map {
      height: 500px;
      width: 100%;
      border-radius: 1rem;
      z-index: 1;
    }
    .itinerary-item {
      transition: all 0.3s ease;
    }
    .itinerary-item.active {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      transform: scale(1.02);
      box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
    }
    .itinerary-item.completed {
      opacity: 0.7;
      background-color: #d1fae5;
    }
    .route-line {
      stroke: #3b82f6;
      stroke-width: 4;
      stroke-dasharray: 10, 5;
      animation: dash 1s linear infinite;
    }
    @keyframes dash {
      to {
        stroke-dashoffset: -15;
      }
    }
    .pulse-marker {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.8;
      }
    }
    .status-badge {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-weight: 600;
      font-size: 0.875rem;
    }
    .status-active {
      background-color: #dbeafe;
      color: #1e40af;
    }
    .status-completed {
      background-color: #d1fae5;
      color: #065f46;
    }
  </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">
  <!-- Top Navigation -->
  <div class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center">
        <a href="plan.html" class="text-2xl text-blue-900 mr-4"><i class="fa fa-arrow-left"></i></a>
        <h2 class="text-2xl font-bold text-gray-800">Live Trip</h2>
      </div>
      <div id="trip-status" class="status-badge status-active">
        <i class="fa-solid fa-map-marker-alt mr-2"></i>Trip In Progress
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Current Stop Info Card -->
    <div id="current-stop-card" class="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-2xl shadow-lg p-6 mb-6">
      <div class="flex items-center justify-between">
        <div class="flex-1">
          <div class="text-sm opacity-90 mb-1">Current Stop</div>
          <h3 id="current-stop-name" class="text-2xl font-bold mb-2">Loading...</h3>
          <div class="flex items-center gap-4 text-sm">
            <div>
              <i class="fa-solid fa-route mr-1"></i>
              <span id="current-distance">-</span>
            </div>
            <div>
              <i class="fa-solid fa-clock mr-1"></i>
              <span id="current-time">-</span>
            </div>
          </div>
        </div>
        <div class="text-right">
          <div class="text-sm opacity-90 mb-1">Next Stop</div>
          <h4 id="next-stop-name" class="text-lg font-semibold">-</h4>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left Column: Itinerary -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-2xl shadow-lg p-6 sticky top-24">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <i class="fa-solid fa-calendar-days text-blue-500 mr-2"></i>
            Day-wise Itinerary
          </h3>
          <div id="itinerary-container" class="space-y-4">
            <!-- Itinerary items will be generated here -->
          </div>
        </div>
      </div>

      <!-- Right Column: Map -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-2xl shadow-lg p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <i class="fa-solid fa-map text-red-500 mr-2"></i>
            Interactive Map
          </h3>
          <div id="map"></div>
          
          <!-- Map Controls -->
          <div class="mt-4 flex gap-4">
            <button id="auto-progress-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl transition">
              <i class="fa-solid fa-play mr-2"></i>Auto Progress
            </button>
            <button id="next-stop-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl transition">
              <i class="fa-solid fa-forward mr-2"></i>Next Stop
            </button>
            <button id="reset-trip-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-3 rounded-xl transition">
              <i class="fa-solid fa-redo"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Trip Completed Modal -->
    <div id="trip-completed-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md mx-4 text-center">
        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fa-solid fa-check text-green-500 text-4xl"></i>
        </div>
        <h2 class="text-3xl font-bold text-gray-800 mb-2">Trip Completed!</h2>
        <p class="text-gray-600 mb-6">Congratulations! You've successfully completed your journey.</p>
        <div class="space-y-2 mb-6 text-left bg-gray-50 p-4 rounded-lg">
          <div class="flex justify-between">
            <span class="text-gray-600">Total Distance:</span>
            <span class="font-semibold" id="total-distance">-</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Total Time:</span>
            <span class="font-semibold" id="total-time">-</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Stops Visited:</span>
            <span class="font-semibold" id="stops-visited">-</span>
          </div>
        </div>
        <div class="flex gap-4">
          <button id="close-modal-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl transition">
            Close
          </button>
          <button id="new-trip-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl transition">
            Plan New Trip
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Trip data and state
    let tripData = null;
    let map = null;
    let currentStopIndex = 0;
    let itinerary = [];
    let markers = [];
    let routes = [];
    let isAutoProgressing = false;
    let autoProgressInterval = null;
    let totalDistance = 0;
    let totalTime = 0;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Check if user is logged in
      const user = localStorage.getItem('user');
      if (!user) {
        alert('Please login to view your trip');
        window.location.href = 'login.html';
        return;
      }

      // Load trip data from localStorage
      const savedTrip = localStorage.getItem('currentTrip');
      if (!savedTrip) {
        alert('No trip data found. Please plan a trip first.');
        window.location.href = 'plan.html';
        return;
      }

      tripData = JSON.parse(savedTrip);
      initializeTrip();
    });

    // Initialize trip
    function initializeTrip() {
      // Build itinerary from trip data
      buildItinerary();
      
      // Initialize map
      initMap();
      
      // Render itinerary
      renderItinerary();
      
      // Set up event listeners
      setupEventListeners();
      
      // Show first stop
      showStop(0);
    }

    // Build day-wise itinerary
    function buildItinerary() {
      const startDate = new Date(tripData.startDate);
      const days = tripData.duration || 1;
      const destinations = tripData.selectedDestinations || [];
      const hotel = tripData.selectedHotel;
      const restaurant = tripData.selectedRestaurant;
      const startLocation = tripData.startLocation;
      const finalDestination = tripData.destination;

      itinerary = [];
      let dayIndex = 0;

      // Day 1: Start to first destination
      if (destinations.length > 0) {
        const day = {
          day: dayIndex + 1,
          date: new Date(startDate),
          items: [
            {
              time: '08:00',
              type: 'travel',
              title: `Travel from ${startLocation}`,
              description: `Departure from starting point`,
              location: startLocation,
              icon: 'fa-car',
              color: 'blue'
            },
            {
              time: '12:00',
              type: 'destination',
              title: `Visit ${destinations[0].name}`,
              description: 'Explore the first destination',
              location: destinations[0].name,
              icon: 'fa-map-marker-alt',
              color: 'red'
            }
          ]
        };
        itinerary.push(day);
        dayIndex++;
      }

      // Add remaining destinations
      for (let i = 1; i < destinations.length; i++) {
        const day = {
          day: dayIndex + 1,
          date: new Date(startDate.getTime() + dayIndex * 24 * 60 * 60 * 1000),
          items: [
            {
              time: '09:00',
              type: 'travel',
              title: `Travel to ${destinations[i].name}`,
              description: `Continue journey`,
              location: destinations[i].name,
              icon: 'fa-car',
              color: 'blue'
            },
            {
              time: '11:00',
              type: 'destination',
              title: `Visit ${destinations[i].name}`,
              description: 'Explore destination',
              location: destinations[i].name,
              icon: 'fa-map-marker-alt',
              color: 'red'
            }
          ]
        };
        itinerary.push(day);
        dayIndex++;
      }

      // Add hotel check-in
      if (hotel) {
        const day = {
          day: dayIndex + 1,
          date: new Date(startDate.getTime() + dayIndex * 24 * 60 * 60 * 1000),
          items: [
            {
              time: '14:00',
              type: 'lunch',
              title: `Lunch at ${restaurant ? restaurant.name : 'Local Restaurant'}`,
              description: 'Enjoy local cuisine',
              location: restaurant ? restaurant.name : 'Restaurant',
              icon: 'fa-utensils',
              color: 'orange'
            },
            {
              time: '16:00',
              type: 'hotel',
              title: `Check-in at ${hotel.name}`,
              description: 'Hotel accommodation',
              location: hotel.name,
              icon: 'fa-bed',
              color: 'blue'
            }
          ]
        };
        itinerary.push(day);
        dayIndex++;
      }

      // Final destination
      if (finalDestination && destinations.length > 0) {
        const day = {
          day: dayIndex + 1,
          date: new Date(startDate.getTime() + dayIndex * 24 * 60 * 60 * 1000),
          items: [
            {
              time: '10:00',
              type: 'travel',
              title: `Travel to ${finalDestination}`,
              description: 'Final leg of journey',
              location: finalDestination,
              icon: 'fa-car',
              color: 'blue'
            },
            {
              time: '14:00',
              type: 'destination',
              title: `Arrive at ${finalDestination}`,
              description: 'Trip completion',
              location: finalDestination,
              icon: 'fa-flag-checkered',
              color: 'green'
            }
          ]
        };
        itinerary.push(day);
      }

      // Flatten itinerary for stop tracking
      itinerary = itinerary.flatMap(day => 
        day.items.map(item => ({
          ...item,
          day: day.day,
          date: day.date
        }))
      );
    }

    // Initialize map
    function initMap() {
      // Initialize map centered on India
      map = L.map('map').setView([20.5937, 78.9629], 5);

      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);

      // Add route from start to all destinations
      drawRoute();
    }

    // Draw route on map
    function drawRoute() {
      const locations = [];
      
      // Add start location
      if (tripData.startLocation) {
        locations.push({ name: tripData.startLocation, type: 'start' });
      }
      
      // Add destinations
      (tripData.selectedDestinations || []).forEach(dest => {
        locations.push({ name: dest.name, type: 'destination' });
      });
      
      // Add restaurant (if exists and different from hotel)
      if (tripData.selectedRestaurant) {
        const restaurantName = tripData.selectedRestaurant.name;
        // Only add if not already in locations
        if (!locations.some(loc => loc.name === restaurantName)) {
          locations.push({ name: restaurantName, type: 'destination' });
        }
      }
      
      // Add hotel
      if (tripData.selectedHotel) {
        locations.push({ name: tripData.selectedHotel.name, type: 'hotel' });
      }
      
      // Add final destination (only if different from last destination)
      if (tripData.destination) {
        const lastLocation = locations[locations.length - 1];
        if (!lastLocation || lastLocation.name !== tripData.destination) {
          locations.push({ name: tripData.destination, type: 'final' });
        }
      }

      // Get coordinates for locations (using geocoding simulation)
      locations.forEach((loc, index) => {
        const coords = getCoordinatesForLocation(loc.name);
        const marker = createMarker(coords, loc, index);
        markers.push(marker);
        marker.addTo(map);
      });

      // Draw route lines
      for (let i = 0; i < markers.length - 1; i++) {
        const startCoords = markers[i].getLatLng();
        const endCoords = markers[i + 1].getLatLng();
        
        const route = L.polyline([startCoords, endCoords], {
          color: '#3b82f6',
          weight: 4,
          opacity: 0.7
        }).addTo(map);
        
        routes.push(route);
      }

      // Fit map to show all markers
      if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
      }
    }

    // Get coordinates for a location (simulated - in production, use geocoding API)
    function getCoordinatesForLocation(locationName) {
      // Simulated coordinates for common Indian locations
      const locationCoords = {
        'delhi': [28.6139, 77.2090],
        'mumbai': [19.0760, 72.8777],
        'bangalore': [12.9716, 77.5946],
        'kolkata': [22.5726, 88.3639],
        'chennai': [13.0827, 80.2707],
        'hyderabad': [17.3850, 78.4867],
        'pune': [18.5204, 73.8567],
        'jaipur': [26.9124, 75.7873],
        'agra': [27.1767, 78.0081],
        'goa': [15.2993, 74.1240],
        'kerala': [10.8505, 76.2711],
        'ladakh': [34.1526, 77.5770],
        'varanasi': [25.3176, 82.9739],
        'udaipur': [24.5854, 73.7125],
        'tirupati': [13.6288, 79.4192]
      };

      const nameLower = locationName.toLowerCase();
      for (const [key, coords] of Object.entries(locationCoords)) {
        if (nameLower.includes(key)) {
          return coords;
        }
      }

      // Default coordinates (center of India) with slight random offset
      const baseLat = 20.5937;
      const baseLng = 78.9629;
      return [
        baseLat + (Math.random() - 0.5) * 10,
        baseLng + (Math.random() - 0.5) * 10
      ];
    }

    // Create marker for location
    function createMarker(coords, location, index) {
      let iconColor = '#3b82f6';
      let icon = 'fa-map-marker-alt';
      
      if (location.type === 'start') {
        iconColor = '#10b981';
        icon = 'fa-play-circle';
      } else if (location.type === 'hotel') {
        iconColor = '#3b82f6';
        icon = 'fa-bed';
      } else if (location.type === 'final') {
        iconColor = '#ef4444';
        icon = 'fa-flag-checkered';
      } else if (location.type === 'destination') {
        iconColor = '#ef4444';
        icon = 'fa-map-marker-alt';
      }

      const marker = L.marker(coords, {
        icon: L.divIcon({
          className: 'custom-marker',
          html: `<div style="background-color: ${iconColor}; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
            <i class="fas ${icon}" style="font-size: 16px;"></i>
          </div>`,
          iconSize: [35, 35],
          iconAnchor: [17.5, 17.5]
        })
      });

      marker.bindPopup(`<b>${location.name}</b><br>${location.type}`);

      return marker;
    }

    // Render itinerary
    function renderItinerary() {
      const container = document.getElementById('itinerary-container');
      container.innerHTML = '';

      itinerary.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = `itinerary-item bg-gray-50 rounded-lg p-4 border border-gray-200 cursor-pointer`;
        itemDiv.dataset.index = index;
        
        const dayLabel = index === 0 || (index > 0 && itinerary[index - 1].day !== item.day) 
          ? `<div class="text-xs font-semibold text-blue-600 mb-2">Day ${item.day} - ${item.date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' })}</div>` 
          : '';

        const colorClasses = {
          blue: { bg: 'bg-blue-100', text: 'text-blue-600' },
          red: { bg: 'bg-red-100', text: 'text-red-600' },
          orange: { bg: 'bg-orange-100', text: 'text-orange-600' },
          green: { bg: 'bg-green-100', text: 'text-green-600' }
        };
        const colorClass = colorClasses[item.color] || colorClasses.blue;

        itemDiv.innerHTML = `
          ${dayLabel}
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0 w-12 h-12 rounded-full ${colorClass.bg} flex items-center justify-center">
              <i class="fas ${item.icon} ${colorClass.text}"></i>
            </div>
            <div class="flex-1">
              <div class="text-xs text-gray-500 mb-1">${item.time}</div>
              <h4 class="font-bold text-gray-800 mb-1">${item.title}</h4>
              <p class="text-sm text-gray-600">${item.description}</p>
            </div>
          </div>
        `;

        container.appendChild(itemDiv);
      });
    }

    // Show specific stop
    function showStop(index) {
      if (index < 0 || index >= itinerary.length) {
        if (index >= itinerary.length) {
          completeTrip();
        }
        return;
      }

      currentStopIndex = index;
      const currentStop = itinerary[index];
      const nextStop = index < itinerary.length - 1 ? itinerary[index + 1] : null;

      // Update current stop card
      document.getElementById('current-stop-name').textContent = currentStop.title;
      document.getElementById('next-stop-name').textContent = nextStop ? nextStop.title : 'Trip End';

      // Calculate distance and time for this segment only
      const distance = calculateDistance(index);
      const time = calculateTime(distance);

      document.getElementById('current-distance').textContent = `${distance.toFixed(1)} km`;
      document.getElementById('current-time').textContent = `${time} min`;

      // Update itinerary UI
      updateItineraryUI();

      // Update map
      updateMap();
    }

    // Calculate distance (simulated based on route segments)
    function calculateDistance(index) {
      if (index === 0) return 0;
      
      // Get current and previous stop locations
      const currentStop = itinerary[index];
      const prevStop = itinerary[index - 1];
      
      // Find corresponding markers
      const currentMarker = markers.find(m => {
        const popup = m.getPopup();
        return popup && popup.getContent().includes(currentStop.location);
      });
      
      const prevMarker = markers.find(m => {
        const popup = m.getPopup();
        return popup && popup.getContent().includes(prevStop.location);
      });
      
      if (currentMarker && prevMarker) {
        // Calculate actual distance between markers
        const distance = currentMarker.getLatLng().distanceTo(prevMarker.getLatLng()) / 1000; // Convert to km
        return Math.max(10, distance); // Minimum 10 km
      }
      
      // Fallback: simulate distance based on stop type
      if (currentStop.type === 'travel') {
        return 50 + Math.random() * 150; // 50-200 km for travel
      } else {
        return 0; // No distance for stops at same location
      }
    }

    // Calculate time (simulated)
    function calculateTime(distance) {
      // Assume average speed of 60 km/h
      return Math.round((distance / 60) * 60);
    }

    // Update itinerary UI
    function updateItineraryUI() {
      const items = document.querySelectorAll('.itinerary-item');
      items.forEach((item, index) => {
        item.classList.remove('active', 'completed');
        if (index === currentStopIndex) {
          item.classList.add('active');
        } else if (index < currentStopIndex) {
          item.classList.add('completed');
        }
      });
    }

      // Update map
      function updateMap() {
      // Determine which route segment corresponds to current stop
      // Each itinerary item that involves travel should correspond to a route segment
      let routeIndex = 0;
      let travelCount = 0;
      const currentStop = itinerary[currentStopIndex];
      
      for (let i = 0; i <= currentStopIndex; i++) {
        if (itinerary[i].type === 'travel') {
          travelCount++;
        }
      }
      
      routeIndex = Math.min(travelCount - 1, routes.length - 1);
      if (routeIndex < 0) routeIndex = 0;

      // Highlight route up to current stop
      routes.forEach((route, index) => {
        if (index < routeIndex) {
          route.setStyle({ color: '#10b981', weight: 5, opacity: 1 });
        } else if (index === routeIndex && currentStop && currentStop.type === 'travel') {
          route.setStyle({ color: '#3b82f6', weight: 5, opacity: 1 });
        } else {
          route.setStyle({ color: '#3b82f6', weight: 4, opacity: 0.3 });
        }
      });

      // Center map on current stop location
      if (currentStop) {
        // Find corresponding marker by location name
        const locationName = currentStop.location;
        const matchingMarker = markers.find(m => {
          const popup = m.getPopup();
          if (popup) {
            const content = popup.getContent();
            return content.includes(locationName);
          }
          return false;
        });
        
        if (matchingMarker) {
          map.setView(matchingMarker.getLatLng(), 12, { animate: true });
          // Open popup for current stop
          setTimeout(() => {
            matchingMarker.openPopup();
          }, 500);
        }
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // Next stop button
      document.getElementById('next-stop-btn').addEventListener('click', () => {
        if (!isAutoProgressing) {
          showStop(currentStopIndex + 1);
        }
      });

      // Auto progress button
      document.getElementById('auto-progress-btn').addEventListener('click', () => {
        if (isAutoProgressing) {
          stopAutoProgress();
        } else {
          startAutoProgress();
        }
      });

      // Reset trip button
      document.getElementById('reset-trip-btn').addEventListener('click', () => {
        if (confirm('Reset trip to beginning?')) {
          resetTrip();
        }
      });

      // Close modal button
      document.getElementById('close-modal-btn').addEventListener('click', () => {
        document.getElementById('trip-completed-modal').classList.add('hidden');
      });

      // New trip button
      document.getElementById('new-trip-btn').addEventListener('click', () => {
        window.location.href = 'plan.html';
      });
    }

    // Start auto progress
    function startAutoProgress() {
      isAutoProgressing = true;
      document.getElementById('auto-progress-btn').innerHTML = '<i class="fa-solid fa-pause mr-2"></i>Pause';
      document.getElementById('auto-progress-btn').classList.remove('bg-blue-500', 'hover:bg-blue-600');
      document.getElementById('auto-progress-btn').classList.add('bg-yellow-500', 'hover:bg-yellow-600');

      autoProgressInterval = setInterval(() => {
        if (currentStopIndex < itinerary.length - 1) {
          showStop(currentStopIndex + 1);
        } else {
          stopAutoProgress();
          completeTrip();
        }
      }, 3000); // Progress every 3 seconds
    }

    // Stop auto progress
    function stopAutoProgress() {
      isAutoProgressing = false;
      if (autoProgressInterval) {
        clearInterval(autoProgressInterval);
        autoProgressInterval = null;
      }
      document.getElementById('auto-progress-btn').innerHTML = '<i class="fa-solid fa-play mr-2"></i>Auto Progress';
      document.getElementById('auto-progress-btn').classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
      document.getElementById('auto-progress-btn').classList.add('bg-blue-500', 'hover:bg-blue-600');
    }

    // Reset trip
    function resetTrip() {
      stopAutoProgress();
      currentStopIndex = 0;
      totalDistance = 0;
      totalTime = 0;
      
      // Reset route styles
      routes.forEach(route => {
        route.setStyle({ color: '#3b82f6', weight: 4, opacity: 0.7 });
      });
      
      showStop(0);
      document.getElementById('trip-status').className = 'status-badge status-active';
      document.getElementById('trip-status').innerHTML = '<i class="fa-solid fa-map-marker-alt mr-2"></i>Trip In Progress';
      
      // Hide modal if open
      document.getElementById('trip-completed-modal').classList.add('hidden');
      document.getElementById('trip-completed-modal').classList.remove('flex');
    }

    // Complete trip
    function completeTrip() {
      stopAutoProgress();
      document.getElementById('trip-status').className = 'status-badge status-completed';
      document.getElementById('trip-status').innerHTML = '<i class="fa-solid fa-check-circle mr-2"></i>Trip Completed';
      
      // Calculate final totals
      let finalDistance = 0;
      let finalTime = 0;
      for (let i = 1; i < itinerary.length; i++) {
        const dist = calculateDistance(i);
        finalDistance += dist;
        finalTime += calculateTime(dist);
      }
      
      // Show completion modal
      document.getElementById('total-distance').textContent = `${finalDistance.toFixed(1)} km`;
      const hours = Math.floor(finalTime / 60);
      const minutes = finalTime % 60;
      document.getElementById('total-time').textContent = hours > 0 
        ? `${hours} hour${hours > 1 ? 's' : ''} ${minutes} minute${minutes !== 1 ? 's' : ''}`
        : `${minutes} minute${minutes !== 1 ? 's' : ''}`;
      document.getElementById('stops-visited').textContent = `${itinerary.length} stops`;
      document.getElementById('trip-completed-modal').classList.remove('hidden');
      document.getElementById('trip-completed-modal').classList.add('flex');
    }
  </script>
</body>
</html>

